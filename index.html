<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Artist — Player</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html, body { height: 100%; }
    .no-select { user-select: none; -webkit-user-select: none; }
    .scrollbar-thin::-webkit-scrollbar { height: 6px; width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,.15); border-radius: 8px; }
  </style>
</head>
<body class="bg-neutral-900 text-white font-sans min-h-screen">
  <div id="app" class="w-full min-h-screen relative">
    <div id="hero"></div>
    <div id="content" class="px-6 md:px-10 pb-36"></div>
    <div id="queue"></div>
    <div id="player"></div>
  </div>

  <script>
    // ==== CONFIG ====
    // Fill these with your project values
    const SUPABASE_URL = (new URL(location.href)).searchParams.get("url") || ""; // e.g. https://rcorxfmfomcjyfyllxfx.supabase.co
    const SUPABASE_ANON_KEY = (new URL(location.href)).searchParams.get("key") || ""; // e.g. your anon key
    const ARTIST_NAME = (new URL(location.href)).searchParams.get("artist") || "Artist";
    const ARTIST_AVATAR = (new URL(location.href)).searchParams.get("avatar") || "https://images.unsplash.com/photo-1527980965255-d3b416303d12?w=256&auto=format&fit=crop&crop=faces";
    const ARTIST_HERO   = (new URL(location.href)).searchParams.get("hero")   || "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?auto=format&fit=crop&w=1600&q=60";

    const sb = (SUPABASE_URL && SUPABASE_ANON_KEY) ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

    // ==== STATE ====
    const state = {
      albums: [],
      loading: true,
      error: "",

      current: null,          // { track, source:{ albumId, albumTitle, cover } }
      queue: [],              // list of items shaped like current
      queueIndex: -1,
      shuffle: false,
      repeat: "off",          // off | all | one

      audioEl: null,
    };

    // ==== HELPERS ====
    const $ = (sel) => document.querySelector(sel);
    const el = (tag, cls="", children=[]) => {
      const e = document.createElement(tag);
      if (cls) e.className = cls;
      if (!Array.isArray(children)) children = [children];
      children.filter(Boolean).forEach(c => {
        if (typeof c === "string") e.appendChild(document.createTextNode(c));
        else e.appendChild(c);
      });
      return e;
    };
    const secondsToClock = (s=0) => {
      s = Math.max(0, Math.floor(s));
      const m = Math.floor(s/60);
      const r = s % 60;
      return `${m}:${r.toString().padStart(2,"0")}`;
    };
    const playIcon = (playing) => playing
      ? '<svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>'
      : '<svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';

    // ==== FETCH ====
    async function loadLibrary(){
      if (!sb) { state.error = "Supabase not configured. Append ?url=...&key=... to the page URL or hardcode values in the file."; state.loading = false; render(); return; }
      try {
        state.loading = true; render();
        const { data: albumsData, error: aErr } = await sb.from("albums").select("*").order("year", { ascending: false });
        if (aErr) throw aErr;
        const { data: tracksData, error: tErr } = await sb.from("tracks").select("*").order("sort_index", { ascending: true });
        if (tErr) throw tErr;

        const byAlbum = {};
        (tracksData||[]).forEach(t => {
          (byAlbum[t.album_id] ||= []).push({
            id: t.id,
            title: t.title,
            duration: t.duration || 0,
            explicit: !!t.explicit,
            url: t.audio_url,
            sort_index: t.sort_index ?? 0
          });
        });
        state.albums = (albumsData||[]).map(a => ({
          id: a.id,
          title: a.title,
          year: a.year,
          cover: a.cover_url,
          tracks: (byAlbum[a.id] || []).sort((x,y)=>(x.sort_index??0)-(y.sort_index??0))
        }));
        state.error = "";
      } catch (e) {
        state.error = String(e?.message || e);
      } finally {
        state.loading = false;
        render();
      }
    }

    // ==== AUDIO CONTROL ====
    function ensureAudioEl(){
      if (state.audioEl) return state.audioEl;
      state.audioEl = document.createElement("audio");
      state.audioEl.preload = "metadata";
      state.audioEl.addEventListener("timeupdate", ()=>{
        const cur = $(".js-time-cur");
        if (cur) cur.textContent = secondsToClock(state.audioEl.currentTime || 0);
        const seek = $(".js-seek");
        if (seek) seek.value = (state.audioEl.currentTime || 0);
      });
      const onDur = ()=>{
        const total = $(".js-time-total");
        if (total) total.textContent = secondsToClock(state.audioEl.duration || 0);
        const seek = $(".js-seek");
        if (seek) seek.max = state.audioEl.duration || 0;
      };
      state.audioEl.addEventListener("durationchange", onDur);
      state.audioEl.addEventListener("loadedmetadata", onDur);
      state.audioEl.addEventListener("ended", ()=> nextTrack(false));
      return state.audioEl;
    }
    function play(){ const a = ensureAudioEl(); a.play(); updatePlayButtons(true); }
    function pause(){ const a = ensureAudioEl(); a.pause(); updatePlayButtons(false); }
    function toggle(){ const a = ensureAudioEl(); if (a.paused) play(); else pause(); }
    function seek(sec){ const a = ensureAudioEl(); a.currentTime = Math.min(Math.max(sec,0), a.duration || Infinity); }
    function setVolume(v){ const a = ensureAudioEl(); a.volume = v; }

    function updatePlayButtons(isPlaying){
      const btns = document.querySelectorAll(".js-play-toggle");
      btns.forEach(b => b.innerHTML = playIcon(isPlaying));
    }

    // ==== QUEUE ====
    function setCurrent(item){
      state.current = item;
      const a = ensureAudioEl();
      a.src = item?.track?.url || "";
      play();
      renderPlayer();
    }
    function enqueue(list, startIndex=0){
      state.queue = list;
      state.queueIndex = startIndex;
      setCurrent(list[startIndex]);
      renderQueue();
    }
    function playItem(item){ enqueue([item], 0); }
    function playCollection(items, index=0){
      let list = [...items];
      if (state.shuffle){
        const selected = list[index];
        list.splice(index,1);
        for (let i=list.length-1;i>0;i--){
          const j = Math.floor(Math.random()*(i+1));
          [list[i],list[j]] = [list[j],list[i]];
        }
        list = [selected, ...list];
        index = 0;
      }
      enqueue(list, index);
    }
    function nextTrack(user=false){
      if (!state.queue.length) return;
      const a = ensureAudioEl();
      if (state.repeat === "one" && !user){ a.currentTime = 0; play(); return; }
      let i = state.queueIndex + 1;
      if (i >= state.queue.length){
        if (state.repeat === "all") i = 0;
        else return;
      }
      state.queueIndex = i;
      setCurrent(state.queue[i]);
      renderQueue();
    }
    function prevTrack(){
      if (!state.queue.length) return;
      const a = ensureAudioEl();
      if ((a.currentTime||0) > 3){ a.currentTime = 0; return; }
      let i = state.queueIndex - 1;
      if (i < 0){ i = (state.repeat === "all") ? state.queue.length - 1 : 0; }
      state.queueIndex = i;
      setCurrent(state.queue[i]);
      renderQueue();
    }

    // ==== RENDER ====
    function render(){
      renderHero();
      renderContent();
      renderQueue();
      renderPlayer();
    }

    function renderHero(){
      const wrap = el("div", "relative");
      const bg = el("div", "h-64 w-full bg-gradient-to-b from-neutral-700/40 to-transparent absolute inset-0 z-0");
      bg.style.backgroundImage = `url(${ARTIST_HERO})`;
      bg.style.backgroundSize = "cover";
      bg.style.backgroundPosition = "center";
      bg.style.opacity = "0.4";
      const row = el("div", "relative z-10 px-6 md:px-10 pt-8 pb-6 flex items-end gap-6");
      const avatar = el("img", "rounded-full shadow-md", []);
      avatar.src = ARTIST_AVATAR; avatar.alt = ARTIST_NAME; avatar.style.width="160px"; avatar.style.height="160px"; avatar.style.objectFit="cover";
      const meta = el("div", "flex-1");
      meta.appendChild(el("div", "text-sm text-white/80 mb-1", "Verified Artist"));
      meta.appendChild(el("h1", "text-5xl md:text-7xl font-extrabold tracking-tight drop-shadow-lg", ARTIST_NAME));
      const buttons = el("div", "mt-4 flex items-center gap-3");
      const playBtn = el("button", "js-play-toggle bg-green-500 hover:bg-green-400 text-black font-semibold rounded-full px-6 py-2 flex items-center gap-2 shadow-xl no-select");
      playBtn.innerHTML = playIcon(false) + '<span>Play</span>';
      playBtn.onclick = () => {
        const popular = computePopular();
        if (state.current) toggle();
        else if (popular.length) playItem(popular[0]);
      };
      buttons.appendChild(playBtn);
      meta.appendChild(buttons);
      row.appendChild(avatar);
      row.appendChild(meta);
      wrap.appendChild(bg);
      wrap.appendChild(row);
      $("#hero").innerHTML = "";
      $("#hero").appendChild(wrap);
    }

    function computeAllTracks(){
      const list = [];
      state.albums.forEach(al => al.tracks.forEach(t => list.push({ track:t, source:{ albumId: al.id, albumTitle: al.title, cover: al.cover } })));
      return list;
    }
    function computePopular(){
      return computeAllTracks().slice(0,5);
    }

    function renderContent(){
      const root = $("#content");
      root.innerHTML = "";

      if (state.loading){
        root.appendChild(el("div", "min-h-[50vh] flex items-center justify-center opacity-80", "Loading…"));
        return;
      }
      if (state.error){
        const box = el("div", "min-h-[50vh] flex items-center justify-center px-6 text-center");
        box.appendChild(el("div", "", [
          el("div", "text-xl font-semibold mb-2", "Couldn't load music"),
          el("div", "opacity-80", state.error)
        ]));
        root.appendChild(box);
        return;
      }

      const popular = computePopular();
      if (popular.length){
        root.appendChild(section("Popular", popularSection(popular)));
      }

      root.appendChild(section("Albums", albumsGrid(state.albums)));
    }

    function section(title, contentEl){
      const s = el("section", "mt-8");
      s.appendChild(el("h2", "text-white/90 text-xl font-semibold mb-3", title));
      s.appendChild(contentEl);
      return s;
    }

    function popularSection(popular){
      const box = el("div", "divide-y divide-white/5 rounded-xl overflow-hidden bg-white/5");
      popular.forEach((it, idx) => {
        const row = el("div", "grid grid-cols-[48px_1fr_80px_40px] md:grid-cols-[48px_1fr_100px_80px_40px] items-center gap-4 px-4 py-3 hover:bg-white/10 cursor-pointer");
        row.ondblclick = () => playCollection(popular, idx);
        row.appendChild(el("div", "text-white/70", String(idx+1)));
        const left = el("div", "flex items-center gap-3");
        const cover = el("img", "rounded-xl shadow-md"); cover.src = it.source.cover; cover.alt = "cover"; cover.style.width="48px"; cover.style.height="48px"; cover.style.objectFit="cover";
        const info = el("div", "");
        info.appendChild(el("div", "font-medium", it.track.title));
        const meta = el("div", "text-xs text-white/60");
        meta.appendChild(document.createTextNode(it.source.albumTitle));
        if (it.track.explicit){ meta.appendChild(el("span", "ml-2 px-1 py-0.5 text-[10px] rounded bg-white/20", "E")); }
        info.appendChild(meta);
        left.appendChild(cover); left.appendChild(info);
        row.appendChild(left);
        row.appendChild(el("div", "hidden md:block text-white/70", secondsToClock(it.track.duration)));
        const addBtn = el("button", "hidden md:inline-flex justify-center");
        addBtn.textContent = "+";
        addBtn.onclick = (e) => { e.stopPropagation(); state.queue = [...state.queue, it]; renderQueue(); };
        row.appendChild(addBtn);
        const dots = el("div", "flex justify-end");
        dots.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="opacity-60"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>';
        row.appendChild(dots);
        box.appendChild(row);
      });
      return box;
    }

    function albumsGrid(albums){
      const grid = el("div", "grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-5");
      albums.forEach(al => {
        const card = el("div", "bg-white/5 hover:bg-white/10 rounded-2xl p-3");
        const toggle = el("button", "text-left w-full");
        const img = el("img", "rounded-xl w-full aspect-square object-cover mb-3 shadow");
        img.src = al.cover; img.alt = al.title;
        const title = el("div", "font-semibold leading-tight", al.title);
        const year = el("div", "text-sm text-white/60", String(al.year));
        toggle.appendChild(img); toggle.appendChild(title); toggle.appendChild(year);
        const tracksWrap = el("div", "mt-3 bg-black/30 rounded-xl divide-y divide-white/5 hidden");
        al.tracks.forEach((t, i) => {
          const row = el("div", "flex items-center justify-between px-3 py-2 hover:bg-white/10");
          const left = el("div", "flex items-center gap-3");
          const playSmall = el("button", "w-8 h-8 rounded-full bg-white/10 flex items-center justify-center");
          playSmall.innerHTML = playIcon(false);
          playSmall.onclick = () => {
            const items = al.tracks.map(tt => ({ track: tt, source: { albumId: al.id, albumTitle: al.title, cover: al.cover } }));
            playCollection(items, i);
          };
          left.appendChild(playSmall);
          left.appendChild(el("div", "font-medium", t.title));
          if (t.explicit) left.appendChild(el("span", "px-1 py-0.5 text-[10px] rounded bg-white/20", "E"));
          row.appendChild(left);
          row.appendChild(el("div", "text-white/60 text-sm", secondsToClock(t.duration)));
          tracksWrap.appendChild(row);
        });
        toggle.onclick = () => { tracksWrap.classList.toggle("hidden"); };
        card.appendChild(toggle);
        card.appendChild(tracksWrap);
        grid.appendChild(card);
      });
      return grid;
    }

    function renderQueue(){
      const wrap = el("div", "fixed top-0 right-0 bottom-24 w-full sm:w-[380px] bg-neutral-950/95 backdrop-blur border-l border-white/10 p-4 overflow-y-auto z-30 hidden scrollbar-thin");
      const head = el("div", "flex items-center justify-between mb-3");
      head.appendChild(el("h3", "text-lg font-semibold", "Queue"));
      const close = el("button", "px-2 py-1 rounded bg-white/10", "Close");
      close.onclick = () => $("#queue").classList.add("hidden");
      head.appendChild(close);
      wrap.appendChild(head);

      const list = el("div", "space-y-2");
      state.queue.forEach((it, i) => {
        const row = el("div", `flex items-center gap-3 p-2 rounded-lg ${i===state.queueIndex ? "bg-white/15" : "bg-white/5"}`);
        const cover = el("img", "rounded-xl shadow-md"); cover.src = it.source.cover; cover.alt = "c"; cover.style.width="56px"; cover.style.height="56px"; cover.style.objectFit="cover";
        const meta = el("div", "flex-1 min-w-0");
        meta.appendChild(el("div", "truncate", it.track.title));
        meta.appendChild(el("div", "text-sm text-white/60 truncate", it.source.albumTitle));
        const controls = el("div", "flex items-center gap-2");
        const up = el("button", "px-2 py-1 bg-white/10 rounded", "↑");
        up.onclick = () => { if (i===0) return; const copy=[...state.queue]; const [x]=copy.splice(i,1); copy.splice(i-1,0,x); state.queue=copy; if (i===state.queueIndex) state.queueIndex=i-1; renderQueue(); };
        const down = el("button", "px-2 py-1 bg-white/10 rounded", "↓");
        down.onclick = () => { if (i===state.queue.length-1) return; const copy=[...state.queue]; const [x]=copy.splice(i,1); copy.splice(i+1,0,x); state.queue=copy; if (i===state.queueIndex) state.queueIndex=i+1; renderQueue(); };
        const del = el("button", "px-2 py-1 bg-white/10 rounded", "✕");
        del.onclick = () => { const copy=[...state.queue]; copy.splice(i,1); state.queue=copy; if (i < state.queueIndex) state.queueIndex -= 1; renderQueue(); };
        controls.appendChild(up); controls.appendChild(down); controls.appendChild(del);
        row.appendChild(cover); row.appendChild(meta); row.appendChild(controls);
        list.appendChild(row);
      });
      wrap.appendChild(list);

      if (state.queue.length){
        const bar = el("div", "mt-3 flex items-center gap-2");
        const clear = el("button", "px-3 py-2 rounded bg-white/10", "Clear");
        clear.onclick = () => { state.queue=[]; state.queueIndex=-1; renderQueue(); };
        const playCur = el("button", "px-3 py-2 rounded bg-white/10", "Play current");
        playCur.onclick = () => { if (state.queueIndex>=0) playItem(state.queue[state.queueIndex]); };
        bar.appendChild(clear); bar.appendChild(playCur);
        wrap.appendChild(bar);
      }

      const holder = $("#queue");
      holder.innerHTML = "";
      holder.className = "";
      holder.appendChild(wrap);
      holder.classList.add("hidden");
    }

    function renderPlayer(){
      const wrap = el("div", "fixed left-0 right-0 bottom-0 bg-neutral-900/95 backdrop-blur border-t border-white/10 px-3 md:px-6 py-3 z-40");
      const grid = el("div", "grid grid-cols-3 items-center gap-3");
      const left = el("div", "flex items-center gap-3 min-w-0");
      if (state.current){
        const cover = el("img", "rounded-xl shadow-md"); cover.src = state.current.source.cover; cover.alt = "now"; cover.style.width="56px"; cover.style.height="56px"; cover.style.objectFit="cover";
        const meta = el("div", "min-w-0");
        meta.appendChild(el("div", "truncate font-medium", state.current.track.title));
        meta.appendChild(el("div", "text-sm text-white/60 truncate", state.current.source.albumTitle));
        left.appendChild(cover); left.appendChild(meta);
      } else {
        left.appendChild(el("div", "text-white/60", "Nothing playing"));
      }

      const center = el("div", "flex flex-col items-center");
      const controls = el("div", "flex items-center gap-4 mb-2");
      const shuffleBtn = el("button", `p-2 rounded hover:bg-white/10 ${state.shuffle ? "bg-white/10" : ""}`);
      shuffleBtn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="'+(state.shuffle?"opacity-100":"opacity-70")+'"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>';
      shuffleBtn.onclick = () => { state.shuffle = !state.shuffle; renderPlayer(); };
      const prevBtn = el("button", "p-2 rounded hover:bg-white/10");
      prevBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 4h2v16H6zM20 5v14L8 12z"/></svg>';
      prevBtn.onclick = prevTrack;
      const playBtn = el("button", "js-play-toggle p-2 rounded-full bg-white text-black w-10 h-10 flex items-center justify-center");
      playBtn.innerHTML = playIcon(state.audioEl && !state.audioEl.paused);
      playBtn.onclick = toggle;
      const nextBtn = el("button", "p-2 rounded hover:bg-white/10");
      nextBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18 4h2v16h-2zM4 5v14l12-7z"/></svg>';
      nextBtn.onclick = () => nextTrack(true);
      const repeatBtn = el("button", `p-2 rounded hover:bg-white/10 ${state.repeat!=="off"?"bg-white/10":""}`);
      repeatBtn.innerHTML = `<div class="relative">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${state.repeat!=="off"?"opacity-100":"opacity-70"}"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
        ${state.repeat==="one" ? '<span class="absolute -bottom-1 -right-1 text-[10px] font-bold">1</span>' : ''}
      </div>`;
      repeatBtn.onclick = () => { state.repeat = state.repeat==="off" ? "all" : state.repeat==="all" ? "one" : "off"; renderPlayer(); };
      controls.appendChild(shuffleBtn); controls.appendChild(prevBtn); controls.appendChild(playBtn); controls.appendChild(nextBtn); controls.appendChild(repeatBtn);

      const seekRow = el("div", "w-full flex items-center gap-2 max-w-xl");
      const cur = el("div", "js-time-cur text-xs w-10 text-right text-white/70", "0:00");
      const seek = el("input", "js-seek w-full");
      seek.type = "range"; seek.min = 0; seek.max = state.audioEl?.duration || 0; seek.value = state.audioEl?.currentTime || 0;
      seek.oninput = (e)=> seek.value = e.target.value;
      seek.onchange = (e)=> seekAudio(Number(e.target.value));
      const total = el("div", "js-time-total text-xs w-10 text-white/70", "0:00");
      seekRow.appendChild(cur); seekRow.appendChild(seek); seekRow.appendChild(total);

      center.appendChild(controls); center.appendChild(seekRow);

      const right = el("div", "flex items-center justify-end gap-3");
      const queueBtn = el("button", "p-2 rounded hover:bg-white/10", "");
      queueBtn.title = "Queue";
      queueBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 6h18v2H3zM3 11h12v2H3zM3 16h8v2H3z"/></svg>';
      queueBtn.onclick = () => $("#queue").classList.toggle("hidden");
      const volWrap = el("div", "flex items-center gap-2 w-40");
      volWrap.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M11 5a7 7 0 0 1 7 7v5h3v2H3v-2h3v-5a7 7 0 0 1 7-7z"/></svg>';
      const vol = el("input", "w-full"); vol.type="range"; vol.min=0; vol.max=1; vol.step=0.01; vol.value = state.audioEl?.volume ?? 0.9;
      vol.oninput = (e)=> setVolume(Number(e.target.value));
      volWrap.appendChild(vol);

      grid.appendChild(left); grid.appendChild(center); grid.appendChild(right);
      right.appendChild(queueBtn); right.appendChild(volWrap);
      wrap.appendChild(grid);

      const holder = $("#player");
      holder.innerHTML = "";
      holder.appendChild(wrap);
    }

    function seekAudio(v){ seek(v); }

    // Keyboard space toggles play
    window.addEventListener("keydown", (e)=>{
      if (e.code === "Space"){ e.preventDefault(); toggle(); }
    });

    // Init
    loadLibrary();
  </script>
</body>
</html>
