<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Waverunners Collective ‚Äî Player</title>
  <meta name="color-scheme" content="dark">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.0/dist/umd/supabase.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0a0a0a; --muted:#a3a3a3; --panel:#111213; --green:#1db954; }
    html,body{background:var(--bg); color:#fff; font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; }
    .panel{ background:linear-gradient(180deg,#121315,#0d0e10); border:1px solid rgba(255,255,255,.06); border-radius:16px; }
    .card{ background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); border-radius:14px; transition:.2s transform, .2s background; }
    .card:hover{ transform:translateY(-2px); background:rgba(255,255,255,.06); }
    .muted{ color:var(--muted); }
    .btn{ background:var(--green); color:#051405; border-radius:999px; padding:.55rem 1rem; font-weight:700; }
    .btn-ghost{ background:rgba(255,255,255,.08); border-radius:999px; padding:.45rem .75rem; }
    .row{ display:grid; grid-template-columns: 1.5rem 1fr auto auto 2rem; gap:1rem; align-items:center; }
    .row:hover{ background:rgba(255,255,255,.06); }
    .queue{ position:fixed; right:0; top:0; bottom:88px; width:360px; max-width:95vw; background:#0f1012; border-left:1px solid rgba(255,255,255,.1); transform:translateX(100%); transition:.25s transform; z-index:40; }
    .queue.open{ transform:translateX(0); }
    .ticker{ position:sticky; top:0; z-index:60; background:#121212; border-bottom:1px solid rgba(255,255,255,.1); }
    .ticker-inner{ max-width:1200px; margin:0 auto; padding:.5rem 1rem; display:flex; justify-content:center; gap:.75rem; align-items:center; }
    .ticker .badge{ background:#f59e0b; color:#111; border-radius:999px; padding:.15rem .5rem; font-weight:800; font-size:.75rem; }
    .timecode{ font-variant-numeric: tabular-nums; }
    .explicit{ display:inline-flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,.4); font-size:.65rem; height:1.15rem; width:1.15rem; border-radius:2px; }
    .mobile-hide{ display:block; }
    @media (max-width: 768px){
      .mobile-hide{ display:none; }
      .row{ grid-template-columns: 1.5rem 1fr auto 2rem; }
    }
    .player{ position:fixed; left:0; right:0; bottom:0; background:#0f1012; border-top:1px solid rgba(255,255,255,.1); padding:.6rem .8rem; display:grid; grid-template-columns: 1fr auto 1fr; gap:.5rem; align-items:center; z-index:45; }
    .range{ appearance:none; width:100%; height:4px; background:#2a2d33; border-radius:999px; }
    .range::-webkit-slider-thumb{ appearance:none; width:14px; height:14px; border-radius:50%; background:#fff; }
    .cover{ background:#111; object-fit:cover; }
    .play-overlay{ position:absolute; right:.5rem; bottom:.5rem; opacity:0; transform:translateY(8px); transition:.2s; }
    .card:hover .play-overlay{ opacity:1; transform:none; }
    .kgrid{ display:grid; grid-template-columns: 1fr; gap:1rem; }
    @media (min-width: 640px){ .kgrid{ grid-template-columns: repeat(3, 1fr); } }
    @media (min-width: 1024px){ .kgrid{ grid-template-columns: repeat(5, 1fr); } }
  </style>
</head>
<body>
  <script>
    // ====== CONFIG (edit these) ======
    const CONFIG = {
      SUPABASE_URL: "https://rcorxfmfomcjyfyllxfx.supabase.co",
      SUPABASE_ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjb3J4Zm1mb21janlmeWxseGZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NTU2ODEsImV4cCI6MjA3MDMzMTY4MX0.ULqfW4yfb-4QfUPoqoCxnPy0yQnW5UhQu9dnEj-8vAk",
      ARTIST_NAME: "The Waverunners Collective",
      ARTIST_LOGO: "https://i.redd.it/5vwpz1s1nbd51.jpg",
      ARTIST_HERO: "https://i.imgur.com/JOdSmu6.png",
      COUNTDOWN: {
        enabled: true, // toggle
        title: "VULTURES OUT IN",
        targetISO: "2025-12-31T23:59:59-06:00"
      }
    };
  </script>

  <!-- Countdown Banner -->
  <div id="countdown" class="ticker" style="display:none">
    <div class="ticker-inner">
      <span class="badge">ANNOUNCEMENT</span>
      <div id="countdownText" class="font-semibold"></div>
    </div>
  </div>

  <!-- Header / Hero -->
  <header class="relative">
    <img src="" id="hero" class="w-full h-[220px] md:h-[320px] object-cover opacity-70" referrerpolicy="no-referrer">
    <div class="absolute inset-0 bg-gradient-to-t from-[rgba(10,10,10,1)] via-[rgba(10,10,10,.6)] to-[rgba(10,10,10,0)]"></div>
    <div class="absolute bottom-4 left-4 right-4 flex items-center gap-4">
      <img id="logo" src="" class="cover w-20 h-20 md:w-28 md:h-28 rounded shadow" referrerpolicy="no-referrer" onerror="this.style.display='none'"/>
      <div>
        <div class="uppercase tracking-widest text-sm muted">Artist</div>
        <h1 id="artistName" class="text-2xl md:text-4xl font-extrabold"></h1>
      </div>
    </div>
    <button id="queueToggle" class="absolute top-3 right-3 btn-ghost" title="Queue">‚ò∞ Queue</button>
  </header>

  <main class="max-w-6xl mx-auto px-4 md:px-6 py-6 space-y-8">
    <!-- Popular Songs -->
    <section>
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-bold">Popular</h2>
      </div>
      <div id="popularList" class="panel p-3 divide-y divide-white/10 rounded-xl"></div>
    </section>

    <!-- Albums Grid -->
    <section>
      <h2 class="text-xl font-bold mb-3">Albums</h2>
      <div id="albumsGrid" class="kgrid"></div>
    </section>
  </main>

  <!-- Queue Drawer -->
  <aside id="queue" class="queue">
    <div class="p-3 border-b border-white/10 flex items-center justify-between">
      <div class="font-bold">Up Next</div>
      <button id="clearQueue" class="btn-ghost text-sm">Clear</button>
    </div>
    <div id="queueItems" class="p-2 space-y-1"></div>
  </aside>

  <!-- Player Bar -->
  <footer class="player">
    <div class="flex items-center gap-3 overflow-hidden">
      <img id="playerCover" class="cover w-12 h-12 rounded hidden md:block" referrerpolicy="no-referrer">
      <div class="min-w-0">
        <div id="playerTitle" class="truncate font-semibold">‚Äî</div>
        <div id="playerSubtitle" class="truncate text-sm muted">‚Äî</div>
      </div>
    </div>
    <div class="flex flex-col items-center gap-2 w-full max-w-3xl mx-auto">
      <div class="flex items-center gap-2">
        <button id="btnShuffle" class="btn-ghost" title="Shuffle">üîÄ</button>
        <button id="btnPrev" class="btn-ghost" title="Prev">‚èÆ</button>
        <button id="btnPlay" class="btn" title="Play/Pause">‚ñ∂Ô∏è</button>
        <button id="btnNext" class="btn-ghost" title="Next">‚è≠</button>
        <button id="btnRepeat" class="btn-ghost" title="Repeat">üîÅ</button>
      </div>
      <div class="flex items-center gap-2 w-full">
        <span id="curTime" class="text-xs muted timecode w-12 text-right">0:00</span>
        <input id="seek" type="range" min="0" max="100" value="0" class="range">
        <span id="durTime" class="text-xs muted timecode w-12">0:00</span>
      </div>
    </div>
    <div class="flex items-center justify-end gap-3">
      <input id="vol" type="range" min="0" max="1" step="0.01" value="1" class="range w-32">
    </div>
    <audio id="audio" crossorigin="anonymous"></audio>
  </footer>

  <script>
    // Utilities
    const $ = (s)=>document.querySelector(s);
    const toClock=(sec=0)=>{ sec=Math.max(0,Math.floor(sec)); const m=Math.floor(sec/60), r=sec%60; return m+\":\"+String(r).padStart(2,\"0\"); };
    function normalizeDropbox(u){
      try{ const url=new URL(u); if(/dropbox\.com$/i.test(url.hostname)){ url.hostname='dl.dropboxusercontent.com'; if(url.searchParams.has('dl')) url.searchParams.delete('dl'); url.searchParams.set('raw','1'); return url.toString(); } return u; }catch{return u;}
    }

    // Supabase
    const sb = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

    // State
    const state = { albums:[], tracksByAlbum:new Map(), queue:[], queueIndex:-1, playing:false, shuffle:false, repeat:'off', current:null, currentAlbumCover:null };

    // Branding & countdown
    function setArtistBranding(){
      $('#artistName').textContent = CONFIG.ARTIST_NAME;
      $('#logo').src = CONFIG.ARTIST_LOGO;
      $('#hero').src = CONFIG.ARTIST_HERO;
      $('#logo').onerror = ()=>$('#logo').style.display='none';
      $('#hero').onerror = ()=>$('#hero').remove();
    }
    function startCountdown(){
      const cfg=CONFIG.COUNTDOWN, wrap=$('#countdown'); if(!cfg.enabled){ wrap.style.display='none'; return; }
      wrap.style.display='block'; const label=$('#countdownText');
      function tick(){ const t=Date.parse(cfg.targetISO); const s=isNaN(t)?0:Math.max(0,Math.floor((t-Date.now())/1000)); const d=Math.floor(s/86400),h=Math.floor((s%86400)/3600),m=Math.floor((s%3600)/60),sec=s%60; label.textContent = `${cfg.title} ${d} Days ${h} Hours ${m} Minutes and ${sec} Seconds`; }
      tick(); setInterval(tick,1000);
    }

    // Data
    async function fetchAlbums(){ const {data,error}=await sb.from('albums').select('*').order('year',{ascending:false}); if(!error) state.albums=data||[]; }
    async function fetchTracks(albumId){
      if(state.tracksByAlbum.has(albumId)) return state.tracksByAlbum.get(albumId);
      const {data,error}=await sb.from('tracks').select('*').eq('album_id',albumId).order('sort_index',{ascending:true});
      const rows=(data||[]).map(t=>({...t, audio_url: normalizeDropbox(t.audio_url||'')}));
      if(!error){ state.tracksByAlbum.set(albumId, rows); return rows; } return [];
    }
    async function fetchPopular(limit=5){ if(!state.albums.length) return []; const tracks=await fetchTracks(state.albums[0].id); return tracks.slice(0,limit); }

    // Render
    async function renderAlbums(){
      const grid=$('#albumsGrid'); grid.innerHTML='';
      for(const a of state.albums){
        const cover=a.cover_url?normalizeDropbox(a.cover_url):'';
        const card=document.createElement('button');
        card.className='card p-3 text-left';
        card.innerHTML=`
          <div class="relative">
            <img src="${cover}" class="w-full aspect-square object-cover rounded-md mb-2" referrerpolicy="no-referrer" onerror="this.src=''; this.style.background='#222';"/>
            <button class="play-overlay btn" title="Play">‚ñ∂Ô∏è</button>
          </div>
          <div class="font-semibold truncate">${a.title||'Untitled'}</div>
          <div class="muted text-sm">${a.year||''}</div>`;
        card.onclick=async()=>{ const tracks=await fetchTracks(a.id); if(tracks.length){ playAlbum(a,tracks); } };
        grid.appendChild(card);
      }
    }
    async function renderPopular(){
      const list=$('#popularList'); list.innerHTML='';
      const tracks=await fetchPopular(5);
      tracks.forEach((t,i)=>{
        const row=document.createElement('div'); row.className='row px-2 rounded cursor-pointer';
        row.innerHTML=`
          <div class="text-sm muted">${i+1}</div>
          <div class="min-w-0">
            <div class="truncate font-semibold">${t.title}</div>
            <div class="muted text-sm">${t.explicit?'<span class="explicit">E</span>':''}</div>
          </div>
          <div class="muted text-sm mobile-hide timecode">${toClock(t.duration||0)}</div>
          <div class="btn-ghost text-lg text-center">‚ãÆ</div>
          <div></div>`;
        row.addEventListener('click',()=>playTrack(t,true));
        list.appendChild(row);
      });
    }

    // Queue & player
    function rebuildQueueUI(){ const box=$('#queueItems'); box.innerHTML=''; state.queue.forEach((t,i)=>{ const row=document.createElement('div'); row.className='flex items-center justify-between gap-2 px-2 py-2 hover:bg-white/5'; row.innerHTML=`<div class="truncate">${t.title}</div><div class="flex items-center gap-2"><div class="muted text-xs timecode">${toClock(t.duration||0)}</div><button class="btn-ghost">‚úï</button></div>`; row.querySelector('button').onclick=()=>{state.queue.splice(i,1); rebuildQueueUI();}; box.appendChild(row); }); }
    function enqueue(t){ state.queue.push(t); rebuildQueueUI(); }
    const audio=$('#audio'); const btnPlay=$('#btnPlay'); const btnNext=$('#btnNext'); const btnPrev=$('#btnPrev'); const btnShuffle=$('#btnShuffle'); const btnRepeat=$('#btnRepeat'); const seek=$('#seek'); const vol=$('#vol'); const curTime=$('#curTime'); const durTime=$('#durTime'); const playerTitle=$('#playerTitle'); const playerSubtitle=$('#playerSubtitle'); const playerCover=$('#playerCover');

    function setMedia(t){ state.current=t; audio.src=normalizeDropbox(t.audio_url||''); audio.load(); playerTitle.textContent=t.title||'‚Äî'; playerSubtitle.textContent=CONFIG.ARTIST_NAME; durTime.textContent=toClock(t.duration||0); const cov=t.cover_url||state.currentAlbumCover; if(cov){ playerCover.src=normalizeDropbox(cov); playerCover.classList.remove('hidden'); } document.title=`${t.title} ‚Ä¢ ${CONFIG.ARTIST_NAME}`; }
    function playTrack(t, replaceQueue=false){ if(replaceQueue){ state.queue=[t]; state.queueIndex=0; rebuildQueueUI(); } setMedia(t); audio.play().catch(console.warn); state.playing=true; btnPlay.textContent='‚è∏'; }
    function playAlbum(album,tracks){ state.currentAlbumCover=album.cover_url; state.queue=[...tracks]; state.queueIndex=0; rebuildQueueUI(); playTrack(tracks[0]); }

    btnPlay.onclick=()=>{ if(!audio.src) return; if(state.playing){ audio.pause(); state.playing=false; btnPlay.textContent='‚ñ∂Ô∏è'; } else { audio.play().catch(console.warn); state.playing=true; btnPlay.textContent='‚è∏'; } };
    btnNext.onclick=()=>{ state.queueIndex++; if(state.queueIndex>=state.queue.length){ if(state.repeat==='all'){ state.queueIndex=0; } else { state.queueIndex=state.queue.length-1; return; } } playTrack(state.queue[state.queueIndex]); };
    btnPrev.onclick=()=>{ state.queueIndex=Math.max(0,state.queueIndex-1); playTrack(state.queue[state.queueIndex]); };
    btnShuffle.onclick=()=>{ state.shuffle=!state.shuffle; btnShuffle.style.background=state.shuffle?'rgba(255,255,255,.2)':'rgba(255,255,255,.08)'; };
    btnRepeat.onclick=()=>{ state.repeat=(state.repeat==='off'?'all': state.repeat==='all'?'one':'off'); btnRepeat.textContent=(state.repeat==='one'?'üîÇ':'üîÅ'); };
    audio.addEventListener('ended', ()=>{ if(state.repeat==='one'){ playTrack(state.current); return; } btnNext.onclick(); });
    audio.addEventListener('timeupdate', ()=>{ const d=audio.duration||(state.current?.duration||0); const c=audio.currentTime||0; curTime.textContent=toClock(c); durTime.textContent=toClock(d); if(d>0) seek.value=Math.floor((c/d)*100); });
    audio.addEventListener('error', (e)=>{ console.error('Audio load error', audio.src, e); alert('Could not load this audio URL. If it is a Dropbox link, ensure it is a shared file; we convert links automatically.'); });
    seek.addEventListener('input', ()=>{ const d=audio.duration||(state.current?.duration||0); const pct=parseInt(seek.value||'0',10)/100; if(d>0){ audio.currentTime=pct*d; } });
    vol.addEventListener('input', ()=> audio.volume=parseFloat(vol.value||'1') );

    // Queue drawer
    const queueEl=$('#queue'); $('#queueToggle').onclick=()=>queueEl.classList.toggle('open'); $('#clearQueue').onclick=()=>{ state.queue.length=0; state.queueIndex=-1; rebuildQueueUI(); };

    // Init
    (async function init(){ setArtistBranding(); startCountdown(); await fetchAlbums(); await renderAlbums(); await renderPopular(); })();
  </script>
</body>
</html>
